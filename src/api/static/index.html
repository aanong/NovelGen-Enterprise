<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelGen Enterprise Â· å†™ä½œæŒ‡æŒ¥éƒ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .vis-network {
            outline: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">N
                </div>
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    NovelGen Enterprise Â· å†™ä½œæŒ‡æŒ¥éƒ¨</h1>
            </div>

            <div class="flex gap-4 items-center">
                <!-- Novel Selector -->
                <div class="relative group flex items-center gap-2">
                    <select v-model="selectedNovelId" @change="fetchData"
                        class="appearance-none bg-slate-100 border-none rounded-lg py-2 pl-4 pr-10 text-sm font-medium focus:ring-2 focus:ring-blue-500 cursor-pointer hover:bg-slate-200 transition-colors">
                        <option v-for="novel in novels" :key="novel.id" :value="novel.id">
                            {{ novel.title }}
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500" style="right: 32px;">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                    <button @click="showNewNovelModal = true" title="æ–°å»ºå°è¯´"
                        class="w-8 h-8 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-lg flex items-center justify-center text-lg font-bold transition-colors">
                        +
                    </button>
                </div>

                <!-- Branch Selector -->
                <div class="relative group flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">åˆ†æ”¯</span>
                    <input v-model="currentBranch" @change="fetchData" type="text"
                        class="bg-slate-100 border-none rounded-lg py-2 px-3 text-sm font-medium w-32 focus:ring-2 focus:ring-purple-500"
                        placeholder="main">
                </div>

                <div class="w-px h-6 bg-gray-300 mx-2"></div>

                <button @click="exportNovel" :disabled="!selectedNovelId" title="å¯¼å‡ºå°è¯´"
                    class="text-gray-500 hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-slate-100 disabled:opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>

                <button @click="fetchData"
                    class="text-gray-500 hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>

                <button @click="triggerGeneration" :disabled="isGenerating || !selectedNovelId"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:shadow-none flex items-center gap-2">
                    <span v-if="isGenerating" class="animate-spin">âŸ³</span>
                    {{ isGenerating ? 'æ­£åœ¨ç”Ÿæˆâ€¦ï¼ˆåˆ«çœ¨çœ¼ï¼‰' : 'ç”Ÿæˆä¸‹ä¸€ç« ' }}
                </button>
            </div>
        </header>

        <!-- Main Workspace -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar Navigation -->
            <nav class="w-64 bg-white border-r border-gray-200 flex flex-col p-4 gap-2">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                    :class="['flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200', 
                             currentTab === tab.id ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-600 hover:bg-slate-50 hover:text-gray-900']">
                    <span class="text-xl">{{ tab.icon }}</span>
                    {{ tab.name }}
                </button>

                <div class="mt-auto pt-4 border-t border-gray-100">
                    <div class="bg-slate-50 rounded-lg p-3">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-2">ç”ŸæˆçŠ¶æ€</p>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-gray-700">{{ currentStep }}</span>
                            <span
                                :class="['w-2 h-2 rounded-full', isGenerating ? 'bg-green-500 animate-pulse' : 'bg-gray-300']"></span>
                        </div>
                        <div v-if="streamingContent"
                            class="mt-2 text-[10px] text-gray-500 font-mono leading-tight max-h-20 overflow-hidden relative">
                            {{ streamingContent.slice(-100) }}...
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-50 to-transparent"></div>
                        </div>
                        <button v-if="isGenerating" @click="cancelGeneration"
                            class="mt-2 w-full text-xs bg-red-100 hover:bg-red-200 text-red-600 py-1.5 rounded font-medium transition-colors">
                            å–æ¶ˆç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-slate-50 p-8 relative">

                <!-- Tab: Overview -->
                <div v-if="currentTab === 'dashboard'" class="space-y-8 max-w-6xl mx-auto">
                    <!-- Metrics Row -->
                    <div class="grid grid-cols-4 gap-6">
                        <div v-for="stat in stats" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">{{ stat.label }}
                            </p>
                            <div class="flex items-end justify-between">
                                <span class="text-3xl font-bold text-gray-800">{{ stat.value }}</span>
                                <span :class="['text-xs font-medium px-2 py-1 rounded-full', stat.color]">{{ stat.trend
                                    }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-8">
                        <!-- Recent Chapters -->
                        <div
                            class="col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[600px]">
                            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">ç« èŠ‚è¿›åº¦</h3>
                                <span class="text-xs text-gray-400">æŒ‰æ—¶é—´å€’åº</span>
                            </div>
                            <div class="overflow-y-auto flex-1 p-2">
                                <div v-for="chapter in chapters" :key="chapter.id"
                                    class="p-4 hover:bg-slate-50 rounded-xl cursor-group transition-colors group">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span
                                                class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded mr-2">ç¬¬
                                                {{ chapter.chapter_number }} ç« </span>
                                            <span
                                                class="font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{{
                                                chapter.title || 'æ— é¢˜ä¹Ÿç®—é¢˜' }}</span>
                                        </div>
                                        <span class="text-xs text-gray-400 font-mono">{{ formatDate(chapter.created_at)
                                            }}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 line-clamp-2 leading-relaxed">{{ chapter.summary ||
                                        'æš‚æ— æ‘˜è¦ï¼ˆå®ƒå¯èƒ½åœ¨è·¯ä¸Šï¼‰' }}</p>

                                    <div class="mt-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click="viewChapter(chapter)"
                                            class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1 rounded-md hover:border-blue-500 hover:text-blue-600">é˜…è¯»</button>
                                        <button
                                            class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1 rounded-md hover:border-purple-500 hover:text-purple-600">å®¡è®¡æ—¥å¿—</button>
                                    </div>
                                </div>
                                <div v-if="chapters.length === 0"
                                    class="h-full flex items-center justify-center text-gray-400 flex-col gap-2">
                                    <span class="text-4xl">ğŸ“­</span>
                                    <p>è¿˜æ²¡å¼€å†™ï¼Œå…ˆåˆ«å‚¬ï¼ˆç‚¹å³ä¸Šè§’ç”Ÿæˆï¼‰</p>
                                </div>
                            </div>
                        </div>

                        <!-- Outline / Future -->
                        <div
                            class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[600px]">
                            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50">
                                <h3 class="font-bold text-gray-800">å¾…å†™æ¸…å•</h3>
                            </div>
                            <div class="p-4 space-y-4 overflow-y-auto flex-1">
                                <div v-for="outline in pendingOutlines" :key="outline.id"
                                    class="relative pl-6 pb-2 border-l-2 border-blue-100 last:border-0 ml-2">
                                    <div
                                        class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-blue-500 ring-4 ring-white">
                                    </div>
                                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 ml-2">
                                        <p class="text-xs font-bold text-blue-600 mb-1">Chapter {{
                                            outline.chapter_number }}</p>
                                        <p class="text-sm text-gray-700 font-medium mb-1">{{ outline.scene_description
                                            }}</p>
                                        <p class="text-xs text-slate-500">{{ outline.key_conflict }}</p>
                                    </div>
                                </div>
                                <div v-if="pendingOutlines.length === 0" class="text-center p-8 text-sm text-gray-400">
                                    å¤§çº²éƒ½å†™å®Œäº†ï¼Œæ¥ä¸‹æ¥å°±å·®ä½ æŒ‰æŒ‰é’®äº†ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Knowledge Graph -->
                <div v-show="currentTab === 'graph'"
                    class="h-full flex flex-col rounded-2xl overflow-hidden shadow-sm border border-gray-200 bg-white">
                    <div class="flex-1 flex">
                        <!-- Left: Character List -->
                        <div class="w-80 border-r border-gray-200 overflow-y-auto p-4 bg-gray-50">
                            <h3 class="font-bold text-gray-800 mb-4 px-2">è§’è‰²åˆ—è¡¨ï¼ˆ{{ characters.length }}ï¼‰</h3>
                            <div class="space-y-3">
                                <div v-for="char in characters" :key="char.id"
                                    class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                    <div class="flex justify-between items-start">
                                        <div class="font-bold text-gray-800">{{ char.name }}</div>
                                        <span
                                            class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200">{{
                                            char.role }}</span>
                                    </div>
                                    <div class="mt-2 text-xs space-y-1 text-gray-500">
                                        <div class="flex gap-1 justify-between"><span>å¿ƒæƒ…ï¼š</span> <span
                                                class="font-medium text-gray-700">{{ char.current_mood }}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Vis.js Network -->
                        <div class="flex-1 relative bg-slate-50">
                            <div id="relationship-network" class="absolute inset-0"></div>
                            <div
                                class="absolute top-4 right-4 bg-white/90 backdrop-blur p-3 rounded-lg shadow text-xs text-gray-600 space-y-1 z-10">
                                <div class="flex items-center gap-2"><span
                                        class="w-2 h-2 rounded-full bg-blue-500"></span> ç›Ÿå‹</div>
                                <div class="flex items-center gap-2"><span
                                        class="w-2 h-2 rounded-full bg-red-500"></span> æ•Œå¯¹</div>
                                <div class="flex items-center gap-2"><span
                                        class="w-2 h-2 rounded-full bg-gray-400"></span> ä¸­ç«‹</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: World Building -->
                <div v-if="currentTab === 'world'" class="max-w-6xl mx-auto space-y-8">
                    <!-- Items -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span>ğŸ“¦</span> ä¸–ç•Œè¦ç´ 
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="item in worldItems" :key="item.id"
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:border-blue-300 transition-colors">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-gray-800">{{ item.name }}</h3>
                                    <span
                                        :class="['text-xs px-2 py-1 rounded-full border', getRarityClass(item.rarity)]">{{
                                        item.rarity }}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">{{ item.description }}</p>
                                <div
                                    class="flex justify-between items-center text-xs text-gray-400 font-mono pt-3 border-t border-gray-50">
                                    <span>ä½ç½®ï¼š{{ item.location || 'æœªçŸ¥' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bible Entries -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span>ğŸ“œ</span> è®¾å®šåœ£ç»
                        </h2>
                        <div
                            class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden divide-y divide-gray-100">
                            <div v-for="entry in bibleEntries" :key="entry.id" class="group">
                                <div class="p-4 cursor-pointer hover:bg-slate-50 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs font-bold uppercase text-gray-400 w-16 text-right">{{
                                            entry.category }}</span>
                                        <span class="font-bold text-gray-800">{{ entry.key }}</span>
                                    </div>
                                    <span class="text-xs text-gray-400 group-hover:text-gray-600">é‡è¦åº¦ï¼š{{
                                        entry.importance }}</span>
                                </div>
                                <div
                                    class="px-4 pb-4 ml-16 text-sm text-gray-600 hidden group-hover:block animate-fade-in">
                                    {{ entry.content }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Foreshadowing Tracker (New Feature) -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span>ğŸ§¶</span> ä¼ç¬”çº¿å¤´
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Active Threads -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-amber-400"></div>
                                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span> æœªå›æ”¶ä¼ç¬”
                                </h3>
                                <div v-if="activeThreads.length > 0" class="space-y-3">
                                    <div v-for="(thread, idx) in activeThreads" :key="idx"
                                        class="bg-amber-50 p-3 rounded-lg border border-amber-100 text-sm text-gray-700">
                                        {{ thread }}
                                    </div>
                                </div>
                                <div v-else class="text-sm text-gray-400 italic">æš‚æ—¶æ²¡æ£€æµ‹åˆ°ä¼ç¬”ï¼šè¿™æ˜¯å¥½äº‹ï¼Œä¹Ÿæ˜¯åäº‹ã€‚</div>
                            </div>

                            <!-- Resolved Threads (Placeholder for now, or we can track history) -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden opacity-75">
                                <div class="absolute top-0 left-0 w-1 h-full bg-green-400"></div>
                                <h3 class="font-bold text-gray-800 mb-3 text-gray-500">å·²å›æ”¶ä¼ç¬”</h3>
                                <div class="text-sm text-gray-400 italic">
                                    å·²å›æ”¶çš„ä¼ç¬”æš‚æ—¶å½’æ¡£åœ¨ç« èŠ‚æ—¥å¿—é‡Œã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Characters Management -->
                <div v-if="currentTab === 'characters'" class="max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">è§’è‰²ç®¡ç†</h2>
                        <button @click="showNewCharacterModal = true" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <span>+</span> æ–°å»ºè§’è‰²
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="char in characters" :key="char.id"
                            class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-gray-800 text-lg">{{ char.name }}</h3>
                                <span :class="['text-xs px-2 py-1 rounded-full', 
                                    char.role === 'Protagonist' ? 'bg-blue-100 text-blue-700' : 
                                    char.role === 'Antagonist' ? 'bg-red-100 text-red-700' : 
                                    'bg-gray-100 text-gray-600']">{{ char.role }}</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">å½“å‰å¿ƒæƒ…</span>
                                    <span class="font-medium text-gray-700">{{ char.current_mood || 'å¹³é™' }}</span>
                                </div>
                                <div v-if="char.personality_traits?.personality" class="text-gray-600">
                                    <span class="text-gray-400">æ€§æ ¼ï¼š</span>{{ char.personality_traits.personality }}
                                </div>
                                <div v-if="char.skills && char.skills.length" class="flex flex-wrap gap-1 mt-2">
                                    <span v-for="skill in char.skills.slice(0, 3)" :key="skill"
                                        class="text-xs bg-purple-50 text-purple-600 px-2 py-0.5 rounded">{{ skill }}</span>
                                    <span v-if="char.skills.length > 3" class="text-xs text-gray-400">+{{ char.skills.length - 3 }}</span>
                                </div>
                            </div>
                            <div class="mt-4 pt-3 border-t border-gray-100 flex gap-2">
                                <button @click="openEditCharacter(char)"
                                    class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-200">ç¼–è¾‘</button>
                                <button @click="deleteCharacter(char.id)"
                                    class="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded hover:bg-red-100">åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div v-if="characters.length === 0" 
                            class="col-span-full text-center py-12 text-gray-400">
                            <span class="text-4xl block mb-2">ğŸ‘¤</span>
                            è¿˜æ²¡æœ‰è§’è‰²ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»º
                        </div>
                    </div>
                </div>

                <!-- Tab: Outlines Management -->
                <div v-if="currentTab === 'outlines'" class="max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">å¤§çº²ç®¡ç†</h2>
                        <button @click="openNewOutline"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <span>+</span> æ–°å»ºå¤§çº²
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="text-left px-6 py-3 text-xs font-bold text-gray-500 uppercase">ç« èŠ‚</th>
                                    <th class="text-left px-6 py-3 text-xs font-bold text-gray-500 uppercase">åœºæ™¯æè¿°</th>
                                    <th class="text-left px-6 py-3 text-xs font-bold text-gray-500 uppercase">æ ¸å¿ƒå†²çª</th>
                                    <th class="text-left px-6 py-3 text-xs font-bold text-gray-500 uppercase">çŠ¶æ€</th>
                                    <th class="text-right px-6 py-3 text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="outline in outlines" :key="outline.id" class="hover:bg-gray-50">
                                    <td class="px-6 py-4">
                                        <span class="font-bold text-blue-600">ç¬¬ {{ outline.chapter_number }} ç« </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-700 max-w-xs truncate">
                                        {{ outline.scene_description }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                                        {{ outline.key_conflict }}
                                    </td>
                                    <td class="px-6 py-4">
                                        <span :class="['text-xs px-2 py-1 rounded-full',
                                            isChapterWritten(outline.chapter_number) ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700']">
                                            {{ isChapterWritten(outline.chapter_number) ? 'å·²å®Œæˆ' : 'å¾…å†™' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <button @click="deleteOutline(outline.id)"
                                            class="text-xs text-red-600 hover:text-red-800">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="outlines.length === 0" class="text-center py-12 text-gray-400">
                            <span class="text-4xl block mb-2">ğŸ“‹</span>
                            è¿˜æ²¡æœ‰å¤§çº²ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»º
                        </div>
                    </div>
                </div>

                <!-- Tab: Project Settings -->
                <div v-if="currentTab === 'settings'" class="max-w-4xl mx-auto space-y-6">
                    <h2 class="text-xl font-bold text-gray-800">é¡¹ç›®è®¾ç½®</h2>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-6">
                        <!-- Novel Info -->
                        <div>
                            <h3 class="font-bold text-gray-700 mb-4">å°è¯´ä¿¡æ¯</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-500 mb-1">æ ‡é¢˜</label>
                                    <p class="font-medium text-gray-800">{{ currentNovel?.title || '-' }}</p>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-500 mb-1">ä½œè€…</label>
                                    <p class="font-medium text-gray-800">{{ currentNovel?.author || '-' }}</p>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm text-gray-500 mb-1">ç®€ä»‹</label>
                                    <p class="text-gray-700">{{ currentNovel?.description || 'æš‚æ— ç®€ä»‹' }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="border-gray-100">
                        
                        <!-- Actions -->
                        <div>
                            <h3 class="font-bold text-gray-700 mb-4">æ“ä½œ</h3>
                            <div class="flex gap-3">
                                <button @click="showNewNovelModal = true"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                    æ–°å»ºå°è¯´
                                </button>
                                <button @click="exportNovel"
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium">
                                    å¯¼å‡ºå°è¯´
                                </button>
                                <button v-if="isGenerating" @click="cancelGeneration"
                                    class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-medium">
                                    å–æ¶ˆç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                        
                        <hr class="border-gray-100">
                        
                        <!-- Statistics -->
                        <div>
                            <h3 class="font-bold text-gray-700 mb-4">ç»Ÿè®¡ä¿¡æ¯</h3>
                            <div class="grid grid-cols-4 gap-4">
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-blue-600">{{ chapters.length }}</p>
                                    <p class="text-xs text-gray-500">ç« èŠ‚æ•°</p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-purple-600">{{ characters.length }}</p>
                                    <p class="text-xs text-gray-500">è§’è‰²æ•°</p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-amber-600">{{ outlines.length }}</p>
                                    <p class="text-xs text-gray-500">å¤§çº²æ•°</p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-green-600">{{ totalWordCount }}</p>
                                    <p class="text-xs text-gray-500">æ€»å­—æ•°</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- Chapter Reader Modal -->
        <div v-if="selectedChapter" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="selectedChapter = null"></div>
            <div
                class="bg-white w-full max-w-3xl h-[85vh] rounded-2xl shadow-2xl z-10 flex flex-col overflow-hidden animate-scale-up">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">ç¬¬ {{ selectedChapter.chapter_number }} ç« </h2>
                        <p class="text-gray-500 text-sm">{{ selectedChapter.title }}</p>
                    </div>
                    <button @click="selectedChapter = null"
                        class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-gray-600">
                        &times;
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-10 bg-[#faf9f6]">
                    <div
                        class="prose prose-slate max-w-none text-lg leading-loose font-serif text-gray-800 whitespace-pre-wrap">
                        {{ selectedChapter.content }}
                    </div>
                </div>
            </div>
        </div>

        <!-- New Novel Modal -->
        <div v-if="showNewNovelModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showNewNovelModal = false"></div>
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl z-10 overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">æ–°å»ºå°è¯´</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜ *</label>
                        <input v-model="newNovelForm.title" type="text" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥å°è¯´æ ‡é¢˜">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä½œè€…</label>
                        <input v-model="newNovelForm.author" type="text"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥ä½œè€…å">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç®€ä»‹</label>
                        <textarea v-model="newNovelForm.description" rows="3"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥å°è¯´ç®€ä»‹"></textarea>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                    <button @click="showNewNovelModal = false"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                    <button @click="createNovel" :disabled="!newNovelForm.title"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                        åˆ›å»º
                    </button>
                </div>
            </div>
        </div>

        <!-- New Character Modal -->
        <div v-if="showNewCharacterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showNewCharacterModal = false"></div>
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl z-10 overflow-hidden max-h-[90vh] flex flex-col">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">æ–°å»ºè§’è‰²</h2>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto flex-1">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åç§° *</label>
                            <input v-model="newCharacterForm.name" type="text"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                placeholder="è§’è‰²åç§°">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²ç±»å‹</label>
                            <select v-model="newCharacterForm.role"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="Protagonist">ä¸»è§’</option>
                                <option value="Antagonist">åæ´¾</option>
                                <option value="Supporting">é…è§’</option>
                                <option value="Minor">é¾™å¥—</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ€§æ ¼ç‰¹å¾</label>
                        <input v-model="newCharacterForm.personality" type="text"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="å¦‚ï¼šå†·é™ã€ç¿æ™ºã€é‡æƒ…ä¹‰">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èƒŒæ™¯æ•…äº‹</label>
                        <textarea v-model="newCharacterForm.background" rows="2"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="è§’è‰²çš„èƒŒæ™¯æ•…äº‹"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŠ€èƒ½ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input v-model="newCharacterForm.skills" type="text"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="å¦‚ï¼šå‰‘æœ¯,è½»åŠŸ,åŒ»æœ¯">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¦å¿Œè¡Œä¸ºï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input v-model="newCharacterForm.forbidden_actions" type="text"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="å¦‚ï¼šèƒŒå›åŒä¼´,æ€å®³æ— è¾œ">
                    </div>
                </div>
                <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                    <button @click="showNewCharacterModal = false"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                    <button @click="createCharacter" :disabled="!newCharacterForm.name"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                        åˆ›å»º
                    </button>
                </div>
            </div>
        </div>

        <!-- New Outline Modal -->
        <div v-if="showNewOutlineModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showNewOutlineModal = false"></div>
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl z-10 overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">æ–°å»ºå¤§çº²</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç« èŠ‚å· *</label>
                        <input v-model.number="newOutlineForm.chapter_number" type="number" min="1"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åœºæ™¯æè¿° *</label>
                        <textarea v-model="newOutlineForm.scene_description" rows="2"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="æè¿°æœ¬ç« çš„ä¸»è¦åœºæ™¯"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ ¸å¿ƒå†²çª</label>
                        <textarea v-model="newOutlineForm.key_conflict" rows="2"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="æœ¬ç« çš„æ ¸å¿ƒå†²çªæˆ–çŸ›ç›¾"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¼ç¬”ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input v-model="newOutlineForm.foreshadowing" type="text"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="å¦‚ï¼šç¥ç§˜ä¿¡ä»¶,æš—è—æ€æœº">
                    </div>
                </div>
                <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                    <button @click="showNewOutlineModal = false"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                    <button @click="createOutline" :disabled="!newOutlineForm.scene_description"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                        åˆ›å»º
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, computed, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Core Data
                const novels = ref([]);
                const selectedNovelId = ref(null);
                const currentBranch = ref('main');

                // Entity Data
                const chapters = ref([]);
                const characters = ref([]);
                const outlines = ref([]);
                const relationships = ref([]);
                const worldItems = ref([]);
                const bibleEntries = ref([]);
                const activeThreads = ref([]);

                // UI State
                const currentTab = ref('dashboard');
                const isGenerating = ref(false);
                const selectedChapter = ref(null);
                const streamingContent = ref('');
                const currentStep = ref('å¾…å‘½');

                // Visual configs
                const tabs = [
                    { id: 'dashboard', name: 'æ€»è§ˆ', icon: 'ğŸ“Š' },
                    { id: 'graph', name: 'å…³ç³»ç½‘', icon: 'ğŸ•¸ï¸' },
                    { id: 'world', name: 'ä¸–ç•Œè§‚', icon: 'ğŸŒ' },
                    { id: 'characters', name: 'è§’è‰²ç®¡ç†', icon: 'ğŸ‘¥' },
                    { id: 'outlines', name: 'å¤§çº²ç®¡ç†', icon: 'ğŸ“' },
                    { id: 'settings', name: 'é¡¹ç›®è®¾ç½®', icon: 'âš™ï¸' },
                ];
                
                // æ–°å¢ï¼šæ¨¡æ€æ¡†çŠ¶æ€
                const showNewNovelModal = ref(false);
                const showNewCharacterModal = ref(false);
                const showEditCharacterModal = ref(false);
                const showNewOutlineModal = ref(false);
                const editingCharacter = ref(null);
                
                // æ–°å¢ï¼šè¡¨å•æ•°æ®
                const newNovelForm = ref({ title: '', author: '', description: '' });
                const newCharacterForm = ref({ 
                    name: '', role: 'Supporting', 
                    personality: '', background: '', 
                    skills: '', forbidden_actions: '' 
                });
                const newOutlineForm = ref({
                    chapter_number: 1,
                    scene_description: '',
                    key_conflict: '',
                    foreshadowing: ''
                });

                const stats = computed(() => {
                    return [
                        { label: 'ç« èŠ‚æ€»æ•°', value: chapters.value.length, trend: 'æœ€æ–°', color: 'bg-blue-100 text-blue-700' },
                        { label: 'æ´»è·ƒè§’è‰²', value: characters.value.length, trend: 'è·Ÿè¸ªä¸­', color: 'bg-purple-100 text-purple-700' },
                        { label: 'ä¸–ç•Œè¦ç´ ', value: worldItems.value.length, trend: 'å·²æ”¶å½•', color: 'bg-amber-100 text-amber-700' },
                        { label: 'è®¾å®šæ¡ç›®', value: bibleEntries.value.length, trend: 'å·²ç´¢å¼•', color: 'bg-green-100 text-green-700' },
                    ]
                });

                const pendingOutlines = computed(() => {
                    const lastChapterNum = chapters.value.length > 0
                        ? Math.max(...chapters.value.map(c => c.chapter_number))
                        : 0;
                    return outlines.value.filter(o => o.chapter_number > lastChapterNum).slice(0, 5);
                });

                // API Calls
                const fetchNovels = async () => {
                    try {
                        const res = await axios.get('/api/novels/');
                        novels.value = res.data;
                        if (novels.value.length > 0 && !selectedNovelId.value) {
                            selectedNovelId.value = novels.value[0].id;
                            fetchData();
                        }
                    } catch (e) { console.error(e); }
                };

                const fetchData = async () => {
                    if (!selectedNovelId.value) return;
                    try {
                        const [chapRes, charRes, outRes, relRes, worldRes, bibleRes] = await Promise.all([
                            axios.get(`/api/chapters/?novel_id=${selectedNovelId.value}&branch_id=${currentBranch.value}`),
                            axios.get(`/api/characters/?novel_id=${selectedNovelId.value}`), // Characters are global for now, but state might be branched
                            axios.get(`/api/outlines/?novel_id=${selectedNovelId.value}&branch_id=${currentBranch.value}`),
                            axios.get(`/api/relationships/?novel_id=${selectedNovelId.value}`),
                            axios.get(`/api/world/items?novel_id=${selectedNovelId.value}`),
                            axios.get(`/api/world/bible?novel_id=${selectedNovelId.value}`)
                        ]);

                        chapters.value = chapRes.data.sort((a, b) => b.chapter_number - a.chapter_number);
                        characters.value = charRes.data;
                        outlines.value = outRes.data;
                        relationships.value = relRes.data;
                        worldItems.value = worldRes.data;

                        // Separating system state from normal bible entries
                        const allBible = bibleRes.data;
                        bibleEntries.value = allBible.filter(b => b.category !== 'system_state');

                        // Parse global foreshadowing
                        const sysState = allBible.find(b => b.category === 'system_state' && b.key === 'global_foreshadowing');
                        if (sysState) {
                            try {
                                activeThreads.value = JSON.parse(sysState.content);
                            } catch { activeThreads.value = []; }
                        } else {
                            activeThreads.value = [];
                        }

                        if (currentTab.value === 'graph') {
                            renderNetwork();
                        }
                    } catch (e) { console.error(e); }
                };

                // Graph Visualization
                let network = null;
                const renderNetwork = () => {
                    const container = document.getElementById('relationship-network');
                    if (!container) return;

                    const nodes = characters.value.map(c => ({
                        id: c.id,
                        label: c.name,
                        shape: 'dot',
                        size: 20,
                        color: c.role === 'Protagonist' ? '#2563eb' : '#64748b' // Blue for protagonist, gray else
                    }));

                    const edges = relationships.value.map(r => ({
                        from: r.char_a_id,
                        to: r.char_b_id,
                        color: r.intimacy > 50 ? '#22c55e' : (r.intimacy < -20 ? '#ef4444' : '#9ca3af'),
                        width: Math.abs(r.intimacy) / 10 + 1
                    }));

                    const data = { nodes, edges };
                    const options = {
                        physics: { stabilization: true },
                        nodes: { font: { face: 'Inter', color: '#334155' } }
                    };

                    if (network) {
                        network.setData(data);
                    } else {
                        network = new vis.Network(container, data, options);
                    }
                };

                watch(currentTab, (val) => {
                    if (val === 'graph') {
                        nextTick(() => renderNetwork());
                    }
                });

                // Interaction
                const triggerGeneration = async () => {
                    if (!selectedNovelId.value) return;
                    isGenerating.value = true;
                    streamingContent.value = '';
                    currentStep.value = 'å¯åŠ¨ä¸­â€¦';

                    try {
                        const res = await axios.post('/api/generate/', {
                            novel_id: selectedNovelId.value,
                            branch_id: currentBranch.value
                        });
                        startStream(res.data.task_id);
                    } catch (e) {
                        isGenerating.value = false;
                        alert('å¯åŠ¨å¤±è´¥ï¼š' + (e?.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                };

                const startStream = (taskId) => {
                    const es = new EventSource(`/api/generate/stream/${taskId}`);
                    let closed = false;
                    let lastActivityTime = Date.now();
                    let activityCheckInterval = null;
                    
                    // è¶…æ—¶æ£€æŸ¥ï¼šå¦‚æœ 5 åˆ†é’Ÿæ²¡æœ‰æ´»åŠ¨ï¼Œè§†ä¸ºè¶…æ—¶
                    const TIMEOUT_MS = 5 * 60 * 1000;
                    
                    const finish = ({ step, alertMessage } = {}) => {
                        if (closed) return;
                        closed = true;
                        if (step) currentStep.value = step;
                        es.close();
                        isGenerating.value = false;
                        if (activityCheckInterval) {
                            clearInterval(activityCheckInterval);
                            activityCheckInterval = null;
                        }
                        fetchData();
                        if (alertMessage) alert(alertMessage);
                    };
                    
                    // å®šæœŸæ£€æŸ¥æ˜¯å¦è¶…æ—¶
                    activityCheckInterval = setInterval(() => {
                        if (Date.now() - lastActivityTime > TIMEOUT_MS) {
                            finish({ step: 'è¶…æ—¶ â±ï¸', alertMessage: 'ç”Ÿæˆè¶…æ—¶ï¼Œè¯·æ£€æŸ¥åå°ä»»åŠ¡çŠ¶æ€æˆ–é‡è¯•' });
                        }
                    }, 10000);
                    
                    // é€šç”¨æ¶ˆæ¯å¤„ç†
                    es.onmessage = (e) => {
                        lastActivityTime = Date.now();
                        try {
                            const d = JSON.parse(e.data);
                            if (d.type === 'done') {
                                finish({ step: 'å®Œæˆ âœ…' });
                            } else if (d.type === 'error') {
                                finish({ step: 'å‡ºé”™äº† âŒ', alertMessage: 'ç”Ÿæˆå¤±è´¥ï¼š' + (d.data?.message || d.message || 'æœªçŸ¥é”™è¯¯') });
                            } else if (d.type === 'status') {
                                const stepMap = {
                                    load_context: 'åŠ è½½ä¸Šä¸‹æ–‡',
                                    refine_context: 'æ•´ç†ä¸Šä¸‹æ–‡',
                                    plan: 'è§„åˆ’å‰§æƒ…',
                                    write: 'å†™ä½œä¸­',
                                    review: 'å®¡ç¨¿ä¸­',
                                    evolve: 'è¿›åŒ–ä¸­'
                                };
                                const stepData = d.data || d;
                                const stepLabel = stepMap[stepData.step] || stepData.step || 'å¤„ç†ä¸­';
                                const statusLabel = stepData.status === 'started' ? 'å¼€å§‹' : (stepData.status === 'completed' ? 'å®Œæˆ' : stepData.status || '');
                                currentStep.value = `${stepLabel} Â· ${statusLabel}`;
                            } else if (d.type === 'token') {
                                const tokenData = d.data || d;
                                streamingContent.value += (tokenData.content || '');
                            }
                        } catch {
                            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                            streamingContent.value += e.data;
                        }
                    };
                    
                    es.addEventListener('token', (e) => {
                        lastActivityTime = Date.now();
                        try {
                            const d = JSON.parse(e.data);
                            streamingContent.value += (d.content || d);
                        } catch { streamingContent.value += e.data; }
                    });
                    es.addEventListener('status', (e) => {
                        lastActivityTime = Date.now();
                        if (closed) return;
                        try {
                            const d = JSON.parse(e.data);
                            const stepMap = {
                                load_context: 'åŠ è½½ä¸Šä¸‹æ–‡',
                                refine_context: 'æ•´ç†ä¸Šä¸‹æ–‡',
                                plan: 'è§„åˆ’å‰§æƒ…',
                                write: 'å†™ä½œä¸­',
                                review: 'å®¡ç¨¿ä¸­',
                                evolve: 'è¿›åŒ–ä¸­'
                            };
                            const stepLabel = stepMap[d.step] || d.step || 'å¤„ç†ä¸­';
                            const statusLabel = d.status === 'started' ? 'å¼€å§‹' : (d.status === 'completed' ? 'å®Œæˆ' : d.status);
                            currentStep.value = `${stepLabel} Â· ${statusLabel}`;
                        } catch {
                            currentStep.value = 'å¤„ç†ä¸­â€¦';
                        }
                    });
                    es.addEventListener('done', (e) => {
                        finish({ step: 'å®Œæˆ âœ…' });
                    });
                    es.addEventListener('error', (e) => {
                        try {
                            const d = JSON.parse(e.data);
                            finish({ step: 'å‡ºé”™äº† âŒ', alertMessage: 'ç”Ÿæˆå¤±è´¥ï¼š' + (d?.message || 'æœªçŸ¥é”™è¯¯') });
                        } catch {
                            // SSE è¿æ¥é”™è¯¯ï¼Œä¸ä¸€å®šæ˜¯ä¸šåŠ¡é”™è¯¯
                            if (!closed) {
                                finish({ step: 'è¿æ¥å¼‚å¸¸' });
                            }
                        }
                    });
                    es.onerror = (e) => {
                        // åªæœ‰åœ¨è¿æ¥çœŸæ­£æ–­å¼€æ—¶æ‰å¤„ç†
                        if (es.readyState === EventSource.CLOSED) {
                            finish({ step: 'è¿æ¥å…³é—­' });
                        }
                    };
                };

                const viewChapter = async (c) => {
                    const res = await axios.get(`/api/chapters/${c.id}`);
                    selectedChapter.value = res.data;
                };

                const getRarityClass = (r) => {
                    const map = {
                        'Common': 'bg-gray-100 text-gray-600 border-gray-200',
                        'Rare': 'bg-blue-50 text-blue-600 border-blue-200',
                        'Epic': 'bg-purple-50 text-purple-600 border-purple-200',
                        'Legendary': 'bg-amber-50 text-amber-600 border-amber-200'
                    };
                    return map[r] || map['Common'];
                };

                const formatDate = (s) => new Date(s).toLocaleString('zh-CN');

                const exportNovel = () => {
                    if (!selectedNovelId.value) return;
                    const url = `/api/novels/${selectedNovelId.value}/export?branch_id=${currentBranch.value}`;
                    window.open(url, '_blank');
                };
                
                // è®¡ç®—å½“å‰å°è¯´
                const currentNovel = computed(() => {
                    return novels.value.find(n => n.id === selectedNovelId.value);
                });
                
                // è®¡ç®—æ€»å­—æ•°
                const totalWordCount = computed(() => {
                    return chapters.value.reduce((sum, c) => sum + (c.content?.length || 0), 0);
                });
                
                // æ£€æŸ¥ç« èŠ‚æ˜¯å¦å·²å†™
                const isChapterWritten = (chapterNum) => {
                    return chapters.value.some(c => c.chapter_number === chapterNum);
                };
                
                // åˆ›å»ºå°è¯´
                const createNovel = async () => {
                    try {
                        const res = await axios.post('/api/novels/', newNovelForm.value);
                        novels.value.push(res.data);
                        selectedNovelId.value = res.data.id;
                        showNewNovelModal.value = false;
                        newNovelForm.value = { title: '', author: '', description: '' };
                        fetchData();
                    } catch (e) {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + (e?.response?.data?.detail || e.message));
                    }
                };
                
                // åˆ›å»ºè§’è‰²
                const createCharacter = async () => {
                    try {
                        const payload = {
                            novel_id: selectedNovelId.value,
                            name: newCharacterForm.value.name,
                            role: newCharacterForm.value.role,
                            personality_traits: {
                                personality: newCharacterForm.value.personality,
                                background: newCharacterForm.value.background
                            },
                            skills: newCharacterForm.value.skills ? newCharacterForm.value.skills.split(',').map(s => s.trim()) : [],
                            forbidden_actions: newCharacterForm.value.forbidden_actions ? 
                                newCharacterForm.value.forbidden_actions.split(',').map(s => s.trim()) : []
                        };
                        await axios.post('/api/characters/', payload);
                        showNewCharacterModal.value = false;
                        newCharacterForm.value = { name: '', role: 'Supporting', personality: '', background: '', skills: '', forbidden_actions: '' };
                        fetchData();
                    } catch (e) {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + (e?.response?.data?.detail || e.message));
                    }
                };
                
                // æ‰“å¼€ç¼–è¾‘è§’è‰²
                const openEditCharacter = (char) => {
                    editingCharacter.value = { ...char };
                    showEditCharacterModal.value = true;
                };
                
                // åˆ é™¤è§’è‰²
                const deleteCharacter = async (id) => {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`/api/characters/${id}`);
                        fetchData();
                    } catch (e) {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + (e?.response?.data?.detail || e.message));
                    }
                };
                
                // æ‰“å¼€æ–°å»ºå¤§çº²
                const openNewOutline = () => {
                    const maxChapter = outlines.value.length > 0 
                        ? Math.max(...outlines.value.map(o => o.chapter_number)) + 1 
                        : 1;
                    newOutlineForm.value.chapter_number = maxChapter;
                    showNewOutlineModal.value = true;
                };
                
                // åˆ›å»ºå¤§çº²
                const createOutline = async () => {
                    try {
                        const payload = {
                            novel_id: selectedNovelId.value,
                            branch_id: currentBranch.value,
                            chapter_number: newOutlineForm.value.chapter_number,
                            scene_description: newOutlineForm.value.scene_description,
                            key_conflict: newOutlineForm.value.key_conflict,
                            foreshadowing: newOutlineForm.value.foreshadowing ? 
                                newOutlineForm.value.foreshadowing.split(',').map(s => s.trim()) : []
                        };
                        await axios.post('/api/outlines/', payload);
                        showNewOutlineModal.value = false;
                        newOutlineForm.value = { chapter_number: 1, scene_description: '', key_conflict: '', foreshadowing: '' };
                        fetchData();
                    } catch (e) {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + (e?.response?.data?.detail || e.message));
                    }
                };
                
                // åˆ é™¤å¤§çº²
                const deleteOutline = async (id) => {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤§çº²å—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`/api/outlines/${id}`);
                        fetchData();
                    } catch (e) {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + (e?.response?.data?.detail || e.message));
                    }
                };
                
                // å–æ¶ˆç”Ÿæˆ
                const cancelGeneration = () => {
                    isGenerating.value = false;
                    currentStep.value = 'å·²å–æ¶ˆ';
                    streamingContent.value = '';
                };

                onMounted(() => fetchNovels());

                return {
                    novels, selectedNovelId, currentBranch,
                    chapters, characters, outlines, pendingOutlines, worldItems, bibleEntries, activeThreads,
                    currentTab, tabs, stats, isGenerating, selectedChapter, streamingContent, currentStep,
                    fetchData, triggerGeneration, viewChapter, getRarityClass, formatDate, exportNovel,
                    // æ–°å¢åŠŸèƒ½
                    currentNovel, totalWordCount, isChapterWritten,
                    showNewNovelModal, showNewCharacterModal, showNewOutlineModal, showEditCharacterModal,
                    newNovelForm, newCharacterForm, newOutlineForm, editingCharacter,
                    createNovel, createCharacter, openEditCharacter, deleteCharacter,
                    openNewOutline, createOutline, deleteOutline, cancelGeneration
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
